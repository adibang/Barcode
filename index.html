<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Barcode</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes buttonPress {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }
        .button-press {
            animation: buttonPress 0.1s ease-in-out;
        }
        .display {
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
        <h1 class="text-2xl font-bold text-center mb-6 text-gray-800">Kalkulator Barcode</h1>
        
        <!-- Display -->
        <div class="bg-gray-900 text-white rounded-lg p-4 mb-4 text-right display text-2xl font-semibold h-16 overflow-x-auto overflow-y-hidden flex items-center justify-end">
            <span id="display">0</span>
        </div>
        
        <!-- Barcode Preview -->
        <div class="mb-6 bg-white p-4 rounded-lg border border-gray-300 flex justify-center">
            <svg id="barcode"></svg>
        </div>
        
        <!-- Notifications -->
        <div id="notification" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-50">
            <span id="notification-text"></span>
        </div>
        
        <!-- Keypad -->
        <div class="grid grid-cols-4 gap-3">
            <!-- Row 1 -->
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150" data-value="1">1</button>
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150" data-value="2">2</button>
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150" data-value="3">3</button>
            <button class="bg-red-500 hover:bg-red-600 text-white font-bold py-4 rounded-lg transition duration-150" id="backspace">←</button>
            
            <!-- Row 2 -->
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150" data-value="4">4</button>
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150" data-value="5">5</button>
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150" data-value="6">6</button>
            <button class="bg-red-500 hover:bg-red-600 text-white font-bold py-4 rounded-lg transition duration-150" id="reset">C</button>
            
            <!-- Row 3 -->
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150" data-value="7">7</button>
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150" data-value="8">8</button>
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150" data-value="9">9</button>
            <button class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 rounded-lg transition duration-150" id="print">P</button>
            
            <!-- Row 4 -->
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150 col-span-2" data-value="0">0</button>
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150" data-value="00">00</button>
        </div>
        
        <div class="mt-6 text-center text-sm text-gray-500">
            <p>Ketik angka di atas untuk menghasilkan barcode</p>
            <p class="mt-1">Format: CODE128</p>
        </div>
    </div>

    <script>
        // Elements
        const display = document.getElementById('display');
        const barcodeSvg = document.getElementById('barcode');
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notification-text');
        
        // State
        let currentValue = '0';
        
        // Initialize barcode with default value
        JsBarcode(barcodeSvg, currentValue, {
            format: "CODE128",
            width: 2,
            height: 80,
            displayValue: true,
            fontSize: 16,
            margin: 10
        });
        
        // Update display and barcode
        function updateDisplay() {
            display.textContent = currentValue;
            
            // Update barcode
            if (currentValue === '0') {
                barcodeSvg.innerHTML = '';
            } else {
                JsBarcode(barcodeSvg, currentValue, {
                    format: "CODE128",
                    width: 2,
                    height: 80,
                    displayValue: true,
                    fontSize: 16,
                    margin: 10
                });
            }
        }
        
        // Show notification
        function showNotification(message, duration = 3000) {
            notificationText.textContent = message;
            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, duration);
        }
        
        // Number button click handler
        document.querySelectorAll('.number-btn').forEach(button => {
            button.addEventListener('click', function() {
                // Add button press animation
                this.classList.add('button-press');
                setTimeout(() => {
                    this.classList.remove('button-press');
                }, 100);
                
                const value = this.getAttribute('data-value');
                
                if (currentValue === '0') {
                    currentValue = value;
                } else {
                    currentValue += value;
                }
                
                updateDisplay();
            });
        });
        
        // Backspace button
        document.getElementById('backspace').addEventListener('click', function() {
            // Add button press animation
            this.classList.add('button-press');
            setTimeout(() => {
                this.classList.remove('button-press');
            }, 100);
            
            if (currentValue.length > 1) {
                currentValue = currentValue.slice(0, -1);
            } else {
                currentValue = '0';
            }
            
            updateDisplay();
        });
        
        // Reset button
        document.getElementById('reset').addEventListener('click', function() {
            // Add button press animation
            this.classList.add('button-press');
            setTimeout(() => {
                this.classList.remove('button-press');
            }, 100);
            
            currentValue = '0';
            updateDisplay();
        });
        
        // Print button
        document.getElementById('print').addEventListener('click', async function() {
            // Add button press animation
            this.classList.add('button-press');
            setTimeout(() => {
                this.classList.remove('button-press');
            }, 100);
            
            if (currentValue === '0') {
                showNotification('Tidak ada barcode untuk dicetak');
                return;
            }
            
            try {
                showNotification('Menyambungkan ke printer Bluetooth...', 5000);
                
                // Check if Web Bluetooth is supported
                if (!navigator.bluetooth) {
                    showNotification('Browser tidak mendukung Web Bluetooth API');
                    return;
                }
                
                // Request Bluetooth device (printer)
                const device = await navigator.bluetooth.requestDevice({
                    filters: [
                        { services: ['generic_access'] },
                        { namePrefix: 'BT' }
                    ],
                    optionalServices: ['generic_access']
                });
                
                showNotification('Terhubung, mencetak...', 3000);
                
                // Simulate printing (actual implementation would require specific printer commands)
                // For demonstration, we'll just show a success message
                setTimeout(() => {
                    showNotification('Barcode berhasil dikirim ke printer!', 3000);
                }, 2000);
                
            } catch (error) {
                console.error('Bluetooth error:', error);
                if (error.name === 'NotFoundError') {
                    showNotification('Tidak ada printer Bluetooth yang ditemukan');
                } else {
                    showNotification('Gagal menyambungkan ke printer');
                }
            }
        });
        
        // Keyboard support
        document.addEventListener('keydown', function(event) {
            const key = event.key;
            
            // Numbers
            if (key >= '0' && key <= '9') {
                const button = document.querySelector(`.number-btn[data-value="${key}"]`);
                if (button) {
                    button.click();
                }
            }
            
            // Special keys
            switch(key) {
                case 'Backspace':
                    document.getElementById('backspace').click();
                    break;
                case 'Delete':
                case 'Escape':
                    document.getElementById('reset').click();
                    break;
                case 'Enter':
                case 'p':
                case 'P':
                    document.getElementById('print').click();
                    break;
            }
        });
    </script>
</body>
</html>    padding: 10px 14px;
    border: none;
    border-radius: 8px;
    background: #1976d2;
    color: white;
    transition: 0.1s;
  }
  button:active {
    background: #0d47a1;
    transform: scale(0.96);
  }
  #barcode {
    background: white;
    display: inline-block;
    padding: 10px;
    border-radius: 10px;
    margin-top: 15px;
  }
  #status {
    font-size: 0.9em;
    color: #555;
    margin-top: 10px;
  }
  .action-btns button {
    font-size: 1em;
    padding: 8px 14px;
    margin: 5px;
    border-radius: 6px;
  }
  .reset { background: #d32f2f; }
  .connect { background: #ffa000; }
  .print { background: #388e3c; }
</style>
</head>
<body>
  <h1>Kalkulator Barcode + Printer</h1>
  <div id="display">0</div>
  <div id="status">Printer: belum terhubung</div>

  <div class="buttons">
    <button>1</button><button>2</button><button>3</button>
    <button>4</button><button>5</button><button>6</button>
    <button>7</button><button>8</button><button>9</button>
    <button>0</button><button>00</button><button>←</button>
  </div>

  <div class="action-btns">
    <button class="reset">Reset</button>
    <button class="connect">Connect</button>
    <button class="print">Print</button>
  </div>

  <canvas id="barcode"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script>
    let current = '';
    const display = document.getElementById('display');
    const barcodeCanvas = document.getElementById('barcode');
    const status = document.getElementById('status');

    document.querySelectorAll('.buttons button').forEach(btn => {
      btn.addEventListener('click', () => {
        const val = btn.textContent;
        if (val === '←') current = current.slice(0, -1);
        else current += val;
        display.textContent = current || '0';
        if (current) JsBarcode(barcodeCanvas, current, { format: "CODE128", width: 2, height: 70 });
      });
    });

    document.querySelector('.reset').addEventListener('click', () => {
      current = '';
      display.textContent = '0';
      barcodeCanvas.getContext('2d').clearRect(0, 0, barcodeCanvas.width, barcodeCanvas.height);
    });

    // koneksi printer
    let port, writer;

    document.querySelector('.connect').addEventListener('click', async () => {
      try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 9600 });
        writer = port.writable.getWriter();
        status.textContent = 'Printer terhubung ✅';
      } catch (e) {
        status.textContent = 'Gagal terhubung ke printer ❌';
      }
    });

    document.querySelector('.print').addEventListener('click', async () => {
      if (!writer) return alert('Hubungkan printer dulu!');
      const data = current ? current : '0';
      const encoder = new TextEncoder();
      await writer.write(encoder.encode(`\x1b@${data}\n\n`));
      status.textContent = `Mencetak barcode: ${data}`;
    });
  </script>
</body>
</html>
    </div>

    <p id="status" class="text-center text-sm text-gray-600 mb-3">Printer: belum terhubung</p>

    <!-- Keypad -->
    <div class="grid grid-cols-4 gap-3">
      <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg" data-value="1">1</button>
      <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg" data-value="2">2</button>
      <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg" data-value="3">3</button>
      <button id="backspace" class="bg-red-500 hover:bg-red-600 text-white font-bold py-4 rounded-lg">←</button>

      <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg" data-value="4">4</button>
      <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg" data-value="5">5</button>
      <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg" data-value="6">6</button>
      <button id="reset" class="bg-red-500 hover:bg-red-600 text-white font-bold py-4 rounded-lg">C</button>

      <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg" data-value="7">7</button>
      <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg" data-value="8">8</button>
      <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg" data-value="9">9</button>
      <button id="print" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 rounded-lg">P</button>

      <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg col-span-2" data-value="0">0</button>
      <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg" data-value="00">00</button>
    </div>

    <div class="mt-6 text-center text-sm text-gray-500">
      <p>Ketik angka di atas untuk menghasilkan barcode (CODE128)</p>
    </div>
  </div>

  <script>
    // State
    let currentValue = '0';
    const displayEl = document.getElementById('display');
    const barcodeSvg = document.getElementById('barcode');
    const statusEl = document.getElementById('status');

    // Connections
    let serialPort = null;
    let serialWriter = null;

    let bleDevice = null;
    let bleServer = null;
    let bleWriteChar = null; // characteristic to write to (if available)

    // Initialize default barcode
    JsBarcode(barcodeSvg, currentValue, {
      format: "CODE128",
      width: 2,
      height: 80,
      displayValue: true,
      fontSize: 16,
      margin: 10
    });

    function updateDisplayAndBarcode() {
      displayEl.textContent = currentValue;
      if (currentValue === '0' || currentValue === '') {
        barcodeSvg.innerHTML = '';
      } else {
        JsBarcode(barcodeSvg, currentValue, {
          format: "CODE128",
          width: 2,
          height: 80,
          displayValue: true,
          fontSize: 16,
          margin: 10
        });
      }
    }

    // Button animation helper
    function pressAnimate(btn) {
      btn.classList.add('press');
      setTimeout(()=>btn.classList.remove('press'), 120);
    }

    // Number buttons
    document.querySelectorAll('.number-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        pressAnimate(btn);
        const v = btn.dataset.value;
        if (currentValue === '0') currentValue = v;
        else currentValue += v;
        updateDisplayAndBarcode();
      });
    });

    // Backspace
    document.getElementById('backspace').addEventListener('click', (e)=>{
      pressAnimate(e.currentTarget);
      if (currentValue.length > 1) currentValue = currentValue.slice(0,-1);
      else currentValue = '0';
      updateDisplayAndBarcode();
    });

    // Reset
    document.getElementById('reset').addEventListener('click', (e)=>{
      pressAnimate(e.currentTarget);
      currentValue = '0';
      updateDisplayAndBarcode();
    });

    // Keyboard support
    document.addEventListener('keydown', (ev)=>{
      const k = ev.key;
      if (k >= '0' && k <= '9') {
        document.querySelector(`.number-btn[data-value="${k}"]`)?.click();
      } else if (k === 'Backspace') {
        document.getElementById('backspace').click();
      } else if (k === 'Enter' || k.toLowerCase() === 'p') {
        document.getElementById('print').click();
      } else if (k === 'Escape') {
        document.getElementById('reset').click();
      }
    });

    // ============================
    // Web Serial (USB/OTG) Helpers
    // ============================
    async function connectSerial() {
      if (!('serial' in navigator)) {
        statusEl.textContent = '❌ Browser tidak mendukung Web Serial API';
        return;
      }
      try {
        serialPort = await navigator.serial.requestPort();
        await serialPort.open({ baudRate: 9600 }); // ubah jika printer kamu butuh baud lain
        serialWriter = serialPort.writable.getWriter();
        statusEl.textContent = '✅ Printer terhubung via USB/Serial';
        statusEl.style.color = 'green';
      } catch (err) {
        console.error('Serial connect err', err);
        statusEl.textContent = '❌ Gagal terhubung ke printer (USB)';
        statusEl.style.color = 'red';
      }
    }

    async function disconnectSerial() {
      try {
        if (serialWriter) {
          serialWriter.releaseLock();
          serialWriter = null;
        }
        if (serialPort) {
          await serialPort.close();
          serialPort = null;
        }
        statusEl.textContent = 'Printer terputus';
      } catch (e) {
        console.warn('disconnectSerial', e);
      }
    }

    // ============================
    // Web Bluetooth (BLE) Helpers
    // ============================
    // Common service/characteristic UUIDs for some BLE printers (may differ per model).
    const BLE_WRITE_CHAR_CANDIDATES = [
      // Many thermal BLE devices use 0xFFE0/0xFFE1 or custom values
      { service: '0000ffe0-0000-1000-8000-00805f9b34fb', char: '0000ffe1-0000-1000-8000-00805f9b34fb' },
      // Nordic UART Service (NUS) — some devices use this
      { service: '6e400001-b5a3-f393-e0a9-e50e24dcca9e', char: '6e400002-b5a3-f393-e0a9-e50e24dcca9e' },
      // Generic writeable service placeholder — may help discovery
      { service: '00001800-0000-1000-8000-00805f9b34fb', char: null }
    ];

    async function connectBLE() {
      if (!navigator.bluetooth) {
        statusEl.textContent = '❌ Browser tidak mendukung Web Bluetooth API';
        return;
      }
      try {
        // Ask user to pick a device — acceptAllDevices true to maximize chance
        bleDevice = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: BLE_WRITE_CHAR_CANDIDATES.map(c => c.service)
        });
        bleDevice.addEventListener('gattserverdisconnected', onBleDisconnected);

        bleServer = await bleDevice.gatt.connect();

        // Try candidate characteristics
        for (const c of BLE_WRITE_CHAR_CANDIDATES) {
          try {
            if (!c.service) continue;
            const svc = await bleServer.getPrimaryService(c.service);
            if (!svc) continue;
            // find writable characteristic (prefer writeWithoutResponse or write)
            if (c.char) {
              const ch = await svc.getCharacteristic(c.char);
              if (ch) {
                bleWriteChar = ch;
                break;
              }
            } else {
              // try to find any characteristic with write
              const chars = await svc.getCharacteristics();
              for (const ch of chars) {
                const props = ch.properties;
                if (props.write || props.writeWithoutResponse) {
                  bleWriteChar = ch;
                  break;
                }
              }
              if (bleWriteChar) break;
            }
          } catch (e) {
            // ignore and try next candidate
          }
        }

        if (bleWriteChar) {
          statusEl.textContent = '✅ Printer BLE terhubung (GATT)';
          statusEl.style.color = 'green';
        } else {
          statusEl.textContent = '⚠️ Perangkat BLE terhubung, tapi tidak ada characteristic tulis yang cocok';
          statusEl.style.color = 'orange';
        }
      } catch (err) {
        console.error('BLE connect err', err);
        statusEl.textContent = '❌ Gagal terhubung via BLE';
        statusEl.style.color = 'red';
      }
    }

    function onBleDisconnected() {
      statusEl.textContent = 'Printer BLE terputus';
      bleDevice = null;
      bleServer = null;
      bleWriteChar = null;
    }

    async function disconnectBLE() {
      try {
        if (bleDevice && bleDevice.gatt.connected) await bleDevice.gatt.disconnect();
        onBleDisconnected();
      } catch (e) {
        console.warn('disconnectBLE', e);
      }
    }

    // ============================
    // Image conversion (SVG -> Canvas -> ESC/POS raster)
    // ============================
    // Convert SVG element to PNG-canvas then to mono bitmap for ESC/POS raster printing.
    async function svgToCanvas(svgEl, targetWidth = 576) {
      // Serialize SVG
      const svgData = new XMLSerializer().serializeToString(svgEl);
      const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
      const url = URL.createObjectURL(svgBlob);

      // Create image
      const img = new Image();
      img.src = url;
      await new Promise((res, rej) => {
        img.onload = () => res();
        img.onerror = (e) => rej(e);
      });

      // Create canvas with target width while keeping aspect ratio
      const scale = targetWidth / img.width;
      const canvas = document.createElement('canvas');
      canvas.width = targetWidth;
      canvas.height = Math.round(img.height * scale);
      const ctx = canvas.getContext('2d');

      // White background then draw
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      URL.revokeObjectURL(url);
      return canvas;
    }

    // Convert canvas -> ESC/POS raster (GS v 0)
    function canvasToEscPosRaster(canvas) {
      const ctx = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;
      const imageData = ctx.getImageData(0, 0, width, height).data;

      // Pad width to multiple of 8
      const bytesPerLine = Math.ceil(width / 8);
      const xL = bytesPerLine & 0xFF;
      const xH = (bytesPerLine >> 8) & 0xFF;
      const yL = height & 0xFF;
      const yH = (height >> 8) & 0xFF;

      // Prepare buffer
      const header = [0x1D,0x76,0x30,0x00, xL, xH, yL, yH];
      const body = [];

      for (let y = 0; y < height; y++) {
        for (let bx = 0; bx < bytesPerLine; bx++) {
          let byte = 0x00;
          for (let bit = 0; bit < 8; bit++) {
            const x = bx * 8 + bit;
            let pixelOn = 0;
            if (x < width) {
              const idx = (y * width + x) * 4;
              const r = imageData[idx];
              const g = imageData[idx + 1];
              const b = imageData[idx + 2];
              // luminance
              const lum = 0.299 * r + 0.587 * g + 0.114 * b;
              // threshold
              if (lum < 127) pixelOn = 1;
            }
            byte |= (pixelOn << (7 - bit));
          }
          body.push(byte);
        }
      }

      return new Uint8Array([...header, ...body]);
    }

    // Utility: send data to serial or BLE
    async function sendToPrinter(buffer) {
      // buffer: Uint8Array or ArrayBuffer
      // Priority: Serial -> BLE
      if (serialWriter) {
        try {
          await serialWriter.write(buffer);
          return { ok: true, via: 'serial' };
        } catch (err) {
          console.error('sendToSerial err', err);
          return { ok: false, error: err };
        }
      } else if (bleWriteChar) {
        try {
          // BLE may limit chunk size (commonly ~20-512). We'll chunk into 512 bytes safe chunks.
          const CHUNK = 512;
          const data = buffer instanceof Uint8Array ? buffer : new Uint8Array(buffer);
          for (let i = 0; i < data.length; i += CHUNK) {
            const slice = data.slice(i, i + CHUNK);
            // prefer writeWithoutResponse when available
            if (bleWriteChar.properties.writeWithoutResponse) {
              await bleWriteChar.writeValueWithoutResponse(slice);
            } else {
              await bleWriteChar.writeValue(slice);
            }
          }
          return { ok: true, via: 'ble' };
        } catch (err) {
          console.error('sendToBLE err', err);
          return { ok: false, error: err };
        }
      } else {
        return { ok: false, error: new Error('No connection') };
      }
    }

    // ============================
    // Print Handler
    // ============================
    async function handlePrint() {
      const btn = document.getElementById('print');
      pressAnimate(btn);

      if (!currentValue || currentValue === '0') {
        alert('Tidak ada barcode untuk dicetak.');
        return;
      }

      // Convert barcode SVG to canvas sized for common thermal width (e.g., 576 px)
      let canvas;
      try {
        canvas = await svgToCanvas(barcodeSvg, 576);
      } catch (e) {
        console.error('SVG->Canvas error', e);
        alert('Gagal membuat gambar barcode untuk dicetak.');
        return;
      }

      // Convert canvas to ESC/POS raster
      const escposData = canvasToEscPosRaster(canvas);

      // Optionally wrap with initial reset command, newline, and cut command
      const init = new Uint8Array([0x1B,0x40]); // ESC @
      const newline = new Uint8Array([0x0A, 0x0A, 0x0A]); // some line feeds
      const cut = new Uint8Array([0x1D,0x56,0x42,0x00]); // GS V B 0 (partial cut)
      const payload = new Uint8Array([...init, ...escposData, ...newline, ...cut]);

      // Send to printer
      statusEl.textContent = 'Mengirim ke printer...';
      statusEl.style.color = '#333';

      const result = await sendToPrinter(payload);
      if (result.ok) {
        statusEl.textContent = `✅ Terkirim via ${result.via.toUpperCase()}`;
        statusEl.style.color = 'green';
      } else {
        console.error('send failed', result.error);
        statusEl.textContent = '❌ Gagal mengirim ke printer. Menyediakan fallback print browser...';
        statusEl.style.color = 'red';
        // fallback: open printable tab
        fallbackPrintCanvas(canvas);
      }
    }

    function fallbackPrintCanvas(canvas) {
      // Open a new tab with the canvas as an image and call window.print
      const dataUrl = canvas.toDataURL('image/png');
      const w = window.open('', '_blank');
      w.document.write(`<html><head><title>Cetak Barcode</title></head><body style="text-align:center; margin:0; padding:20px"><img src="${dataUrl}" style="max-width:100%"><p style="font-family: monospace">${currentValue}</p><script>window.print();<\/script></body></html>`);
      w.document.close();
    }

    // ============================
    // Hook buttons
    // ============================
    document.getElementById('connect-serial').addEventListener('click', async (e)=>{
      pressAnimate(e.currentTarget);
      if (serialPort) {
        await disconnectSerial();
        statusEl.textContent = 'Printer USB terputus';
        serialPort = null;
        serialWriter = null;
        return;
      }
      await connectSerial();
    });

    document.getElementById('connect-ble').addEventListener('click', async (e)=>{
      pressAnimate(e.currentTarget);
      if (bleDevice && bleDevice.gatt.connected) {
        await disconnectBLE();
        statusEl.textContent = 'Printer BLE terputus';
        return;
      }
      await connectBLE();
    });

    document.getElementById('print').addEventListener('click', handlePrint);

    // Keep UI in sync
    updateDisplayAndBarcode();

    // Optional: when page unload, clean up connections
    window.addEventListener('beforeunload', async () => {
      try { if (serialWriter) serialWriter.releaseLock(); } catch(e){}
      try { if (serialPort) await serialPort.close(); } catch(e){}
      try { if (bleDevice && bleDevice.gatt.connected) await bleDevice.gatt.disconnect(); } catch(e){}
    });

  </script>
</body>
</html>
    }
    button {
      font-size: 1.4em;
      padding: 10px;
      border: none;
      border-radius: 10px;
      background: #1976d2;
      color: white;
      transition: 0.1s;
    }
    button:active {
      background: #0d47a1;
      transform: scale(0.97);
    }
    .bottom-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    #barcode {
      margin-top: 20px;
      background: white;
      padding: 10px;
      border-radius: 10px;
    }
    #status {
      margin-top: 10px;
      font-size: 0.9em;
      color: #555;
    }
  </style>
</head>
<body>
  <h2>Kalkulator Barcode + Web Serial</h2>

  <input id="display" readonly placeholder="Masukkan angka" />

  <div class="buttons">
    <button>7</button><button>8</button><button>9</button>
    <button>4</button><button>5</button><button>6</button>
    <button>1</button><button>2</button><button>3</button>
    <button>0</button><button>00</button><button id="back">←</button>
  </div>

  <div class="bottom-buttons">
    <button id="reset" style="background:#d32f2f;">Reset</button>
    <button id="connect" style="background:#ff9800;">Connect</button>
    <button id="print" style="background:#388e3c;">Print</button>
  </div>

  <svg id="barcode"></svg>
  <p id="status">Printer belum terhubung</p>

  <!-- JsBarcode CDN -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

  <script>
    let currentValue = "";
    let port = null;
    let writer = null;

    const display = document.getElementById("display");
    const buttons = document.querySelectorAll(".buttons button");
    const barcode = document.getElementById("barcode");
    const status = document.getElementById("status");

    // Update tampilan barcode
    function updateBarcode() {
      if (!currentValue) {
        barcode.innerHTML = "";
        return;
      }
      JsBarcode(barcode, currentValue, {
        format: "CODE128",
        lineColor: "#000",
        width: 2,
        height: 70,
        displayValue: true
      });
    }

    // Input angka
    buttons.forEach(btn => {
      btn.addEventListener("click", () => {
        if (btn.id === "back") {
          currentValue = currentValue.slice(0, -1);
        } else {
          currentValue += btn.textContent;
        }
        display.value = currentValue;
        updateBarcode();
      });
    });

    // Tombol reset
    document.getElementById("reset").addEventListener("click", () => {
      currentValue = "";
      display.value = "";
      barcode.innerHTML = "";
    });

    // Tombol Connect printer
    document.getElementById("connect").addEventListener("click", async () => {
      if (!("serial" in navigator)) {
        alert("Browser kamu tidak mendukung Web Serial API.\nCoba gunakan Google Chrome versi terbaru.");
        return;
      }

      try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 9600 });
        writer = port.writable.getWriter();
        status.textContent = "✅ Printer terhubung via USB/Serial";
        status.style.color = "green";
      } catch (err) {
        console.error(err);
        status.textContent = "❌ Gagal terhubung ke printer";
        status.style.color = "red";
      }
    });

    // Tombol print (kirim langsung ke printer via Serial)
    document.getElementById("print").addEventListener("click", async () => {
      if (!currentValue) {
        alert("Masukkan angka dulu sebelum mencetak.");
        return;
      }

      if (!writer) {
        alert("Printer belum terhubung.\nKlik tombol Connect dulu.");
        return;
      }

      // Buat data barcode (hanya teks, printer akan mencetak teksnya)
      const text = `\x1B\x40\nBARCODE:\n${currentValue}\n\n`;
      const encoder = new TextEncoder();
      const data = encoder.encode(text);

      try {
        await writer.write(data);
        // Perintah potong kertas (ESC/POS)
        const cut = new Uint8Array([0x1D, 0x56, 0x42, 0x00]);
        await writer.write(cut);
        status.textContent = "✅ Barcode berhasil dikirim ke printer!";
        status.style.color = "green";
      } catch (err) {
        console.error(err);
        alert("Gagal mengirim data ke printer: " + err.message);
      }
    });
  </script>
</body>
</html>
        <!-- Notifications -->
        <div id="notification" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-50">
            <span id="notification-text"></span>
        </div>
        
        <!-- Keypad -->
        <div class="grid grid-cols-4 gap-3">
            <!-- Row 1 -->
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150" data-value="1">1</button>
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150" data-value="2">2</button>
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150" data-value="3">3</button>
            <button class="bg-red-500 hover:bg-red-600 text-white font-bold py-4 rounded-lg transition duration-150" id="backspace">←</button>
            
            <!-- Row 2 -->
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150" data-value="4">4</button>
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150" data-value="5">5</button>
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150" data-value="6">6</button>
            <button class="bg-red-500 hover:bg-red-600 text-white font-bold py-4 rounded-lg transition duration-150" id="reset">C</button>
            
            <!-- Row 3 -->
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150" data-value="7">7</button>
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150" data-value="8">8</button>
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150" data-value="9">9</button>
            <button class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 rounded-lg transition duration-150" id="print">P</button>
            
            <!-- Row 4 -->
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150 col-span-2" data-value="0">0</button>
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150" data-value="00">00</button>
        </div>
        
        <div class="mt-6 text-center text-sm text-gray-500">
            <p>Ketik angka di atas untuk menghasilkan barcode</p>
            <p class="mt-1">Format: CODE128</p>
        </div>
    </div>

    <script>
        // Elements
        const display = document.getElementById('display');
        const barcodeSvg = document.getElementById('barcode');
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notification-text');
        
        // State
        let currentValue = '0';
        
        // Initialize barcode with default value
        JsBarcode(barcodeSvg, currentValue, {
            format: "CODE128",
            width: 2,
            height: 80,
            displayValue: true,
            fontSize: 16,
            margin: 10
        });
        
        // Update display and barcode
        function updateDisplay() {
            display.textContent = currentValue;
            
            // Update barcode
            if (currentValue === '0') {
                barcodeSvg.innerHTML = '';
            } else {
                JsBarcode(barcodeSvg, currentValue, {
                    format: "CODE128",
                    width: 2,
                    height: 80,
                    displayValue: true,
                    fontSize: 16,
                    margin: 10
                });
            }
        }
        
        // Show notification
        function showNotification(message, duration = 3000) {
            notificationText.textContent = message;
            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, duration);
        }
        
        // Number button click handler
        document.querySelectorAll('.number-btn').forEach(button => {
            button.addEventListener('click', function() {
                // Add button press animation
                this.classList.add('button-press');
                setTimeout(() => {
                    this.classList.remove('button-press');
                }, 100);
                
                const value = this.getAttribute('data-value');
                
                if (currentValue === '0') {
                    currentValue = value;
                } else {
                    currentValue += value;
                }
                
                updateDisplay();
            });
        });
        
        // Backspace button
        document.getElementById('backspace').addEventListener('click', function() {
            // Add button press animation
            this.classList.add('button-press');
            setTimeout(() => {
                this.classList.remove('button-press');
            }, 100);
            
            if (currentValue.length > 1) {
                currentValue = currentValue.slice(0, -1);
            } else {
                currentValue = '0';
            }
            
            updateDisplay();
        });
        
        // Reset button
        document.getElementById('reset').addEventListener('click', function() {
            // Add button press animation
            this.classList.add('button-press');
            setTimeout(() => {
                this.classList.remove('button-press');
            }, 100);
            
            currentValue = '0';
            updateDisplay();
        });
        
        // Print button
        document.getElementById('print').addEventListener('click', async function() {
            // Add button press animation
            this.classList.add('button-press');
            setTimeout(() => {
                this.classList.remove('button-press');
            }, 100);
            
            if (currentValue === '0') {
                showNotification('Tidak ada barcode untuk dicetak');
                return;
            }
            
            try {
                showNotification('Menyambungkan ke printer Bluetooth...', 5000);
                
                // Check if Web Bluetooth is supported
                if (!navigator.bluetooth) {
                    showNotification('Browser tidak mendukung Web Bluetooth API');
                    return;
                }
                
                // Request Bluetooth device (printer)
                const device = await navigator.bluetooth.requestDevice({
                    filters: [
                        { services: ['generic_access'] },
                        { namePrefix: 'BT' }
                    ],
                    optionalServices: ['generic_access']
                });
                
                showNotification('Terhubung, mencetak...', 3000);
                
                // Simulate printing (actual implementation would require specific printer commands)
                // For demonstration, we'll just show a success message
                setTimeout(() => {
                    showNotification('Barcode berhasil dikirim ke printer!', 3000);
                }, 2000);
                
            } catch (error) {
                console.error('Bluetooth error:', error);
                if (error.name === 'NotFoundError') {
                    showNotification('Tidak ada printer Bluetooth yang ditemukan');
                } else {
                    showNotification('Gagal menyambungkan ke printer');
                }
            }
        });
        
        // Keyboard support
        document.addEventListener('keydown', function(event) {
            const key = event.key;
            
            // Numbers
            if (key >= '0' && key <= '9') {
                const button = document.querySelector(`.number-btn[data-value="${key}"]`);
                if (button) {
                    button.click();
                }
            }
            
            // Special keys
            switch(key) {
                case 'Backspace':
                    document.getElementById('backspace').click();
                    break;
                case 'Delete':
                case 'Escape':
                    document.getElementById('reset').click();
                    break;
                case 'Enter':
                case 'p':
                case 'P':
                    document.getElementById('print').click();
                    break;
            }
        });
    </script>
</body>
</html>
