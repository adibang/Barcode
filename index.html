<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kalkulator Barcode + Web Serial</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 100vh;
      margin: 0;
      background: #f5f5f5;
    }
    h2 {
      margin: 20px 0 10px;
      color: #222;
    }
    #display {
      width: 240px;
      height: 50px;
      margin-bottom: 15px;
      font-size: 1.5em;
      text-align: right;
      padding: 5px 10px;
      border-radius: 10px;
      border: 2px solid #ccc;
      background: white;
    }
    .buttons {
      display: grid;
      grid-template-columns: repeat(3, 80px);
      gap: 10px;
    }
    button {
      font-size: 1.4em;
      padding: 10px;
      border: none;
      border-radius: 10px;
      background: #1976d2;
      color: white;
      transition: 0.1s;
    }
    button:active {
      background: #0d47a1;
      transform: scale(0.97);
    }
    .bottom-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    #barcode {
      margin-top: 20px;
      background: white;
      padding: 10px;
      border-radius: 10px;
    }
    #status {
      margin-top: 10px;
      font-size: 0.9em;
      color: #555;
    }
  </style>
</head>
<body>
  <h2>Kalkulator Barcode + Web Serial</h2>

  <input id="display" readonly placeholder="Masukkan angka" />

  <div class="buttons">
    <button>7</button><button>8</button><button>9</button>
    <button>4</button><button>5</button><button>6</button>
    <button>1</button><button>2</button><button>3</button>
    <button>0</button><button>00</button><button id="back">←</button>
  </div>

  <div class="bottom-buttons">
    <button id="reset" style="background:#d32f2f;">Reset</button>
    <button id="connect" style="background:#ff9800;">Connect</button>
    <button id="print" style="background:#388e3c;">Print</button>
  </div>

  <svg id="barcode"></svg>
  <p id="status">Printer belum terhubung</p>

  <!-- JsBarcode CDN -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

  <script>
    let currentValue = "";
    let port = null;
    let writer = null;

    const display = document.getElementById("display");
    const buttons = document.querySelectorAll(".buttons button");
    const barcode = document.getElementById("barcode");
    const status = document.getElementById("status");

    // Update tampilan barcode
    function updateBarcode() {
      if (!currentValue) {
        barcode.innerHTML = "";
        return;
      }
      JsBarcode(barcode, currentValue, {
        format: "CODE128",
        lineColor: "#000",
        width: 2,
        height: 70,
        displayValue: true
      });
    }

    // Input angka
    buttons.forEach(btn => {
      btn.addEventListener("click", () => {
        if (btn.id === "back") {
          currentValue = currentValue.slice(0, -1);
        } else {
          currentValue += btn.textContent;
        }
        display.value = currentValue;
        updateBarcode();
      });
    });

    // Tombol reset
    document.getElementById("reset").addEventListener("click", () => {
      currentValue = "";
      display.value = "";
      barcode.innerHTML = "";
    });

    // Tombol Connect printer
    document.getElementById("connect").addEventListener("click", async () => {
      if (!("serial" in navigator)) {
        alert("Browser kamu tidak mendukung Web Serial API.\nCoba gunakan Google Chrome versi terbaru.");
        return;
      }

      try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 9600 });
        writer = port.writable.getWriter();
        status.textContent = "✅ Printer terhubung via USB/Serial";
        status.style.color = "green";
      } catch (err) {
        console.error(err);
        status.textContent = "❌ Gagal terhubung ke printer";
        status.style.color = "red";
      }
    });

    // Tombol print (kirim langsung ke printer via Serial)
    document.getElementById("print").addEventListener("click", async () => {
      if (!currentValue) {
        alert("Masukkan angka dulu sebelum mencetak.");
        return;
      }

      if (!writer) {
        alert("Printer belum terhubung.\nKlik tombol Connect dulu.");
        return;
      }

      // Buat data barcode (hanya teks, printer akan mencetak teksnya)
      const text = `\x1B\x40\nBARCODE:\n${currentValue}\n\n`;
      const encoder = new TextEncoder();
      const data = encoder.encode(text);

      try {
        await writer.write(data);
        // Perintah potong kertas (ESC/POS)
        const cut = new Uint8Array([0x1D, 0x56, 0x42, 0x00]);
        await writer.write(cut);
        status.textContent = "✅ Barcode berhasil dikirim ke printer!";
        status.style.color = "green";
      } catch (err) {
        console.error(err);
        alert("Gagal mengirim data ke printer: " + err.message);
      }
    });
  </script>
</body>
</html>
        <!-- Notifications -->
        <div id="notification" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-50">
            <span id="notification-text"></span>
        </div>
        
        <!-- Keypad -->
        <div class="grid grid-cols-4 gap-3">
            <!-- Row 1 -->
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150" data-value="1">1</button>
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150" data-value="2">2</button>
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150" data-value="3">3</button>
            <button class="bg-red-500 hover:bg-red-600 text-white font-bold py-4 rounded-lg transition duration-150" id="backspace">←</button>
            
            <!-- Row 2 -->
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150" data-value="4">4</button>
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150" data-value="5">5</button>
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150" data-value="6">6</button>
            <button class="bg-red-500 hover:bg-red-600 text-white font-bold py-4 rounded-lg transition duration-150" id="reset">C</button>
            
            <!-- Row 3 -->
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150" data-value="7">7</button>
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150" data-value="8">8</button>
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150" data-value="9">9</button>
            <button class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 rounded-lg transition duration-150" id="print">P</button>
            
            <!-- Row 4 -->
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150 col-span-2" data-value="0">0</button>
            <button class="number-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 rounded-lg transition duration-150" data-value="00">00</button>
        </div>
        
        <div class="mt-6 text-center text-sm text-gray-500">
            <p>Ketik angka di atas untuk menghasilkan barcode</p>
            <p class="mt-1">Format: CODE128</p>
        </div>
    </div>

    <script>
        // Elements
        const display = document.getElementById('display');
        const barcodeSvg = document.getElementById('barcode');
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notification-text');
        
        // State
        let currentValue = '0';
        
        // Initialize barcode with default value
        JsBarcode(barcodeSvg, currentValue, {
            format: "CODE128",
            width: 2,
            height: 80,
            displayValue: true,
            fontSize: 16,
            margin: 10
        });
        
        // Update display and barcode
        function updateDisplay() {
            display.textContent = currentValue;
            
            // Update barcode
            if (currentValue === '0') {
                barcodeSvg.innerHTML = '';
            } else {
                JsBarcode(barcodeSvg, currentValue, {
                    format: "CODE128",
                    width: 2,
                    height: 80,
                    displayValue: true,
                    fontSize: 16,
                    margin: 10
                });
            }
        }
        
        // Show notification
        function showNotification(message, duration = 3000) {
            notificationText.textContent = message;
            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, duration);
        }
        
        // Number button click handler
        document.querySelectorAll('.number-btn').forEach(button => {
            button.addEventListener('click', function() {
                // Add button press animation
                this.classList.add('button-press');
                setTimeout(() => {
                    this.classList.remove('button-press');
                }, 100);
                
                const value = this.getAttribute('data-value');
                
                if (currentValue === '0') {
                    currentValue = value;
                } else {
                    currentValue += value;
                }
                
                updateDisplay();
            });
        });
        
        // Backspace button
        document.getElementById('backspace').addEventListener('click', function() {
            // Add button press animation
            this.classList.add('button-press');
            setTimeout(() => {
                this.classList.remove('button-press');
            }, 100);
            
            if (currentValue.length > 1) {
                currentValue = currentValue.slice(0, -1);
            } else {
                currentValue = '0';
            }
            
            updateDisplay();
        });
        
        // Reset button
        document.getElementById('reset').addEventListener('click', function() {
            // Add button press animation
            this.classList.add('button-press');
            setTimeout(() => {
                this.classList.remove('button-press');
            }, 100);
            
            currentValue = '0';
            updateDisplay();
        });
        
        // Print button
        document.getElementById('print').addEventListener('click', async function() {
            // Add button press animation
            this.classList.add('button-press');
            setTimeout(() => {
                this.classList.remove('button-press');
            }, 100);
            
            if (currentValue === '0') {
                showNotification('Tidak ada barcode untuk dicetak');
                return;
            }
            
            try {
                showNotification('Menyambungkan ke printer Bluetooth...', 5000);
                
                // Check if Web Bluetooth is supported
                if (!navigator.bluetooth) {
                    showNotification('Browser tidak mendukung Web Bluetooth API');
                    return;
                }
                
                // Request Bluetooth device (printer)
                const device = await navigator.bluetooth.requestDevice({
                    filters: [
                        { services: ['generic_access'] },
                        { namePrefix: 'BT' }
                    ],
                    optionalServices: ['generic_access']
                });
                
                showNotification('Terhubung, mencetak...', 3000);
                
                // Simulate printing (actual implementation would require specific printer commands)
                // For demonstration, we'll just show a success message
                setTimeout(() => {
                    showNotification('Barcode berhasil dikirim ke printer!', 3000);
                }, 2000);
                
            } catch (error) {
                console.error('Bluetooth error:', error);
                if (error.name === 'NotFoundError') {
                    showNotification('Tidak ada printer Bluetooth yang ditemukan');
                } else {
                    showNotification('Gagal menyambungkan ke printer');
                }
            }
        });
        
        // Keyboard support
        document.addEventListener('keydown', function(event) {
            const key = event.key;
            
            // Numbers
            if (key >= '0' && key <= '9') {
                const button = document.querySelector(`.number-btn[data-value="${key}"]`);
                if (button) {
                    button.click();
                }
            }
            
            // Special keys
            switch(key) {
                case 'Backspace':
                    document.getElementById('backspace').click();
                    break;
                case 'Delete':
                case 'Escape':
                    document.getElementById('reset').click();
                    break;
                case 'Enter':
                case 'p':
                case 'P':
                    document.getElementById('print').click();
                    break;
            }
        });
    </script>
</body>
</html>
